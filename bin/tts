#!/bin/bash

# Claude Voice TTS Service Control Script
# Manages the Claude Voice TTS Docker container via systemd

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Service name
SERVICE_NAME="claude-voice-tts"

# Helper functions
print_success() {
    echo -e "${GREEN}✓${NC} $1"
}

print_error() {
    echo -e "${RED}✗${NC} $1"
}

print_info() {
    echo -e "${BLUE}ℹ${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}⚠${NC} $1"
}

# Check if service is running
is_running() {
    systemctl --user is-active --quiet "${SERVICE_NAME}.service" 2>/dev/null
}

# Commands
cmd_start() {
    if is_running; then
        print_warning "Kokoro TTS service is already running"
        return 0
    fi

    print_info "Starting Kokoro TTS service..."
    if systemctl --user start "${SERVICE_NAME}.service"; then
        sleep 2
        if is_running; then
            print_success "Kokoro TTS service started successfully"
            print_info "Service available at: http://localhost:8880"
        else
            print_error "Service failed to start. Check logs: tts logs"
            return 1
        fi
    else
        print_error "Failed to start service"
        return 1
    fi
}

cmd_stop() {
    if ! is_running; then
        print_warning "Kokoro TTS service is not running"
        return 0
    fi

    print_info "Stopping Kokoro TTS service..."
    if systemctl --user stop "${SERVICE_NAME}.service"; then
        print_success "Kokoro TTS service stopped"
    else
        print_error "Failed to stop service"
        return 1
    fi
}

cmd_restart() {
    print_info "Restarting Kokoro TTS service..."
    if systemctl --user restart "${SERVICE_NAME}.service"; then
        sleep 2
        if is_running; then
            print_success "Kokoro TTS service restarted successfully"
        else
            print_error "Service failed to restart. Check logs: tts logs"
            return 1
        fi
    else
        print_error "Failed to restart service"
        return 1
    fi
}

cmd_status() {
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "  Kokoro TTS Service Status"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo

    # Service status
    if is_running; then
        print_success "Service: Running"
    else
        print_error "Service: Stopped"
    fi

    # Systemd status
    systemctl --user status "${SERVICE_NAME}.service" --no-pager || true
    echo

    # Docker container status
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "  Docker Container Status"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    docker ps -a --filter "name=claude-voice-tts" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" || print_error "Docker not available"
    echo

    # Configuration
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "  Configuration"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    print_info "Service URL: http://localhost:8880"
    print_info "Config: ~/.config/tts-service/config.json"
    print_info "Logs: journalctl --user -u ${SERVICE_NAME}.service"
    echo
}

cmd_logs() {
    if [ "${1:-}" = "-f" ] || [ "${1:-}" = "--follow" ]; then
        print_info "Following logs (Ctrl+C to stop)..."
        journalctl --user -u "${SERVICE_NAME}.service" -f
    else
        journalctl --user -u "${SERVICE_NAME}.service" -n 50
    fi
}

cmd_enable() {
    print_info "Enabling Kokoro TTS service (auto-start on login)..."
    if systemctl --user enable "${SERVICE_NAME}.service"; then
        print_success "Service enabled"
    else
        print_error "Failed to enable service"
        return 1
    fi
}

cmd_disable() {
    print_info "Disabling Kokoro TTS service auto-start..."
    if systemctl --user disable "${SERVICE_NAME}.service"; then
        print_success "Service disabled"
    else
        print_error "Failed to disable service"
        return 1
    fi
}

cmd_test() {
    print_info "Testing Kokoro TTS service..."
    echo

    # Check if service is running
    if ! is_running; then
        print_error "Service is not running. Start it first: tts start"
        return 1
    fi

    # Test API endpoint
    print_info "Testing API endpoint..."
    if curl -s -f http://localhost:8880/v1/audio/voices > /dev/null 2>&1; then
        print_success "API endpoint is accessible"

        # Show available voices
        echo
        print_info "Available voices:"
        curl -s http://localhost:8880/v1/audio/voices | python3 -m json.tool 2>/dev/null || echo "  (Could not parse response)"
    else
        print_error "API endpoint is not accessible"
        print_info "Check logs: tts logs"
        return 1
    fi

    echo
    print_success "Kokoro TTS service is working correctly!"
}

cmd_help() {
    cat << EOF
Kokoro TTS Service Control

Usage: tts <command> [options]

Commands:
  start       Start the Kokoro TTS service
  stop        Stop the Kokoro TTS service
  restart     Restart the Kokoro TTS service
  status      Show service status and configuration
  logs        Show service logs (use -f to follow)
  enable      Enable auto-start on login
  disable     Disable auto-start
  test        Test if service is working
  help        Show this help message

Examples:
  tts start           # Start the service
  tts logs -f         # Follow logs in real-time
  tts status          # Show detailed status
  tts test            # Test if service is working

Configuration:
  Service URL: http://localhost:8880
  Config: ~/.config/tts-service/config.json
  Systemd service: ~/.config/systemd/user/claude-voice-tts.service

For more information, see: README.md
EOF
}

# Main command router
main() {
    case "${1:-help}" in
        start)
            cmd_start
            ;;
        stop)
            cmd_stop
            ;;
        restart)
            cmd_restart
            ;;
        status)
            cmd_status
            ;;
        logs)
            cmd_logs "${2:-}"
            ;;
        enable)
            cmd_enable
            ;;
        disable)
            cmd_disable
            ;;
        test)
            cmd_test
            ;;
        help|--help|-h)
            cmd_help
            ;;
        *)
            print_error "Unknown command: $1"
            echo
            cmd_help
            exit 1
            ;;
    esac
}

main "$@"
